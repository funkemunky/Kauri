package dev.brighten.anticheat.check.impl.regular.packets.exploits;

import cc.funkemunky.api.tinyprotocol.packet.in.WrappedInWindowClickPacket;
import dev.brighten.anticheat.check.api.Check;
import dev.brighten.anticheat.check.api.CheckInfo;
import dev.brighten.anticheat.check.api.Packet;
import dev.brighten.api.check.CheckType;
import org.bukkit.event.inventory.InventoryType;
import org.bukkit.inventory.InventoryView;

@CheckInfo(name = "WindowCrash", description = "Prevents inventory related crashing", checkType = CheckType.EXPLOIT)
public class WindowCrash extends Check {

    @Packet
    public boolean onWindow(WrappedInWindowClickPacket packet) {
        if(packet.getSlot() < 0 && packet.getSlot() != -999 && packet.getSlot() != -1) {
            vl++;
            flag("Sent slot %s", packet.getSlot());
            return true;
        } else {
            InventoryView view = data.getPlayer().getOpenInventory();

            int maxSlots = 0;
            if(view.getBottomInventory().getType() == InventoryType.PLAYER && view.getTopInventory().getType() == InventoryType.CRAFTING) {
                maxSlots = view.countSlots() + 4;
            } else maxSlots = view.countSlots();

            if(packet.getSlot() > maxSlots) {
                vl++;
                flag("Sent bad slot %s>-%s", packet.getSlot(), maxSlots);
                return true;
            }
        }
        return false;
    }
}
